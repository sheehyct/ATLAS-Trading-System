# Session Start - STRAT Options Backtest Bug Fix

**Read in order:**
1. This file (current priorities)
2. `docs/HANDOFF_OPTIONS_BACKTEST.md` (full context on bug)
3. `docs/CLAUDE.md` (strict compliance - Section 13 on bar classification)

---

## CRITICAL BUG DISCOVERED (Session 85)

### The Bug

**Location:** `scripts/backtest_strat_options_thetadata.py` line 343

```python
# BUGGY CODE
direction = 1 if 'Up' in pattern_type or '2U' in pattern_type else -1
```

**Problem:** Pattern `2U-1-2D` contains "2U" so it's classified as CALL when it should be PUT.

**Impact:** 40+ bearish patterns traded as calls instead of puts.

### The Fix

```python
# CORRECT CODE
direction = 1 if row.get('direction') == 'bullish' else -1
```

---

## Session 86 Priorities

### Priority 1: Fix Direction Bug

1. Edit `scripts/backtest_strat_options_thetadata.py` line 343
2. Use CSV `direction` column instead of pattern name inference
3. Test with a small sample to verify fix

### Priority 2: Re-run Backtests

```bash
cd C:\thetaterminal && java -jar thetaterminalv3.jar  # Start terminal first!

uv run python scripts/backtest_strat_options_thetadata.py --symbol SPY --risk 7
uv run python scripts/backtest_strat_options_thetadata.py --symbol SPY --risk 10
```

### Priority 3: Compare Results

- Document before/after comparison
- Quantify impact of bug fix on:
  - Total P&L
  - Win rate
  - Bearish pattern performance
  - Drawdown characteristics

### Priority 4: Audit VPS Paper Trading (if time)

Check `strat/paper_signal_scanner.py` and `strat/paper_trading.py` for similar issues.

---

## Files to Modify

| File | Change |
|------|--------|
| `scripts/backtest_strat_options_thetadata.py` | Fix line 343 direction logic |

## Files to Audit

| File | Check For |
|------|-----------|
| `strat/paper_signal_scanner.py` | Direction inference from pattern names |
| `strat/paper_trading.py` | Direction handling |
| `strat/tier1_detector.py` | Pattern naming conventions |
| `strat/options_module.py` | Direction logic |

---

## Pattern Naming Standard (MANDATORY)

Per CLAUDE.md Section 13:

| Correct | Incorrect |
|---------|-----------|
| 2D-2U | 2-2 Up |
| 2U-2D | 2-2 Down |
| 2U-1-2U | 2-1-2 Up |
| 2D-1-2D | 2-1-2 Down |
| 3-1-2U | 3-1-2 Up |
| 3-1-2D | 3-1-2 Down |

**Rule:** The EXIT bar (last bar) determines trade direction.

---

## OpenMemory Queries

```
"Session 85 direction bug"
"STRAT bar classification"
"2U-1-2D misclassification"
```

---

## Key Insight

**NEVER infer direction from pattern name strings.**

Pattern "2U-1-2D" contains both "2U" and "2D" - string matching will fail. Always use explicit direction data from the source.

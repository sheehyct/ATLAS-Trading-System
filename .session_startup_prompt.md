# Session Startup Prompt - EQUITY-48

**Previous Session:** EQUITY-47 (January 7, 2026)
**Current Branch:** `main`
**VPS Status:** Pending deployment with logging improvements

---

## Context

### What Was Accomplished (EQUITY-47)

**P1: TFC Logging COMPLETE:**
- Added logging infrastructure to paper_signal_scanner.py
- TFC evaluation logged after COMPLETED pattern detection (line 1208-1217)
- TFC evaluation logged after SETUP pattern detection (line 1335-1344)
- TFC pass/fail counters track results per scan
- TFC summary logged at end of scan (line 1387-1392)

**P2: Filter Rejection Logging COMPLETE:**
- Added logging to daemon.py `_passes_filters()` method
- Logs rejection reason with actual vs threshold values
- Covers magnitude, R:R, and pattern type filters

**Log Format Examples:**
```
TFC Eval: SPY 1D 2D-2U - score=8/10, alignment=Strong, passes_flexible=True, risk_multiplier=1.20, priority_rank=2
TFC Summary: SPY 1D - signals=3, TFC_passed=2, TFC_failed=1
FILTER REJECTED: TSLA_1H_3-2D_PUT - magnitude 0.150% < min 0.5%
```

---

## EQUITY-48 Priorities

### P3: Type 3 Evolution Detection (3 hrs)

**Goal:** Exit when entry bar evolves from Type 2 to Type 3

**Background:** Per STRAT methodology EXECUTION.md Section 8, when the entry bar (the bar we entered on) evolves to Type 3 (breaks both high AND low of setup bar), the pattern premise is invalidated and we should exit immediately.

**Current State:**
- `ExitReason.PATTERN_INVALIDATED` exists (EQUITY-44)
- `_check_pattern_invalidation()` exists in position_monitor.py
- Issue: entry_monitor only receives current price, no bar data

**Implementation Options:**
1. Extend entry_monitor to receive bar data (requires API changes)
2. Add bar tracking to position_monitor (may duplicate work)
3. Periodic bar fetch in position_monitor (existing bar cache approach)

**Files:**
- `strat/signal_automation/position_monitor.py` - Pattern invalidation logic
- `strat/signal_automation/entry_monitor.py` - Entry trigger monitoring

### P4: Signal Lifecycle Tracing (1 hr)

**Goal:** Consistent signal_key logging through entire pipeline

**The Problem:** Signal keys logged inconsistently, making grep-based tracing difficult

**Implementation:**
- Audit all logging statements for signal_key format
- Standardize format: `{symbol}_{timeframe}_{pattern}_{direction}`
- Add lifecycle stage prefixes: DETECTED, STORED, TRIGGERED, EXECUTED, EXITED

---

## Technical Debt Summary

| Priority | Task | Status |
|----------|------|--------|
| P1 | TFC Logging | DONE |
| P2 | Filter Rejection Logging | DONE |
| P3 | Type 3 Evolution Detection | Next |
| P4 | Signal Lifecycle Tracing | Next |
| P5 | TFC Re-evaluation at Entry | Pending |
| P6 | Trade Analytics Dashboard | Pending |

---

## Key Files

- `strat/paper_signal_scanner.py` - TFC logging (P1 complete)
- `strat/signal_automation/daemon.py` - Filter rejection logging (P2 complete)
- `strat/signal_automation/position_monitor.py` - Pattern invalidation (P3 target)
- `strat/signal_automation/entry_monitor.py` - Entry trigger monitoring

---

## Plan File

`C:\Users\sheeh\.claude\plans\twinkling-sauteeing-treehouse.md`

---

## Mandatory Workflow

### During Development
1. **CLAUDE.md Section 2:** Invoke `strat-methodology` skill for ANY STRAT-related work
2. **CLAUDE.md Section 3:** Run tests before claiming functionality works

### Pre-Commit Checklist (BEFORE every commit)
- [ ] Run `/code-review` on changed files
- [ ] If touching trade execution code: Run `pr-review-toolkit:silent-failure-hunter`
- [ ] If adding new functionality: Run `pr-review-toolkit:pr-test-analyzer`
- [ ] Tests pass locally

### Session End Protocol
- [ ] Update docs/HANDOFF.md
- [ ] Update .session_startup_prompt.md
- [ ] Store session facts in OpenMemory
- [ ] Provide summary with next session priorities

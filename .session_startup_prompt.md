# Session Startup Prompt - EQUITY-107

**Previous Session:** EQUITY-106 (February 12, 2026)
**Current Branch:** `main`
**VPS Status:** DEPLOYED - $100K account, all bug fixes live
**Plan Mode:** ON for Priority 1 (position sizing has multiple architecture decisions)
**Parallel Work:** User may have dynamic ticker selection changes in working tree

---

## EQUITY-106 Accomplishments

1. **Paper Account Reset to $100K** - Exported 138 fills + 75 closed trades before reset. New API keys configured locally, VPS, and Railway. PDT eliminated.
2. **VPS Deployment** - Deployed 3-? pattern dedup, EOD PDT detection, and silent exits fix. Daemon running clean on new account.
3. **Bug Fix: Silent Exits** - Root cause: sync_positions silently removed positions that disappeared from Alpaca (no callback, no Discord alert). Also stale 1H exits blocked pre-market by market hours gate, causing race with sync. Fixed both.
4. **Code Simplification** - Extracted _handle_external_close method, simplified pre-market time check.

---

## EQUITY-107 Priorities

### Priority 1: Position Sizing / Virtual Balance System (PLAN MODE)
This is NOT a simple config change. Multiple architecture decisions needed.

**Current state:**
- `executor.py:135`: `max_capital_per_trade = 300.0` (hard-coded)
- `executor.py:681`: `contracts = max_capital_per_trade / (estimated_premium * 100)` (simple division)
- No concept of total portfolio exposure, concurrent position limits, or settlement tracking
- Paper account has $100K, target is to simulate $3K cash account

**Design questions to resolve in plan mode:**
1. **Effective capital tracking** -- How much of virtual $3K is deployed vs available?
2. **Concurrent position limits** -- $3K with $300/trade = ~10 max positions. Correct?
3. **T+1 settlement** -- Cash accounts can't reuse capital same-day after selling options. Need to track settled vs in-flight capital.
4. **Max portfolio heat** -- Total risk across all open positions (% of effective capital)
5. **Per-trade sizing** -- Fixed $300? % of effective capital? Volatility-based (ATR)?
6. **STRAT methodology sizing** -- R:R based sizing, pattern conviction multipliers
7. **Skill check** -- Invoke `position-sizing-risk` skill before implementation

**Files to investigate:**
- `strat/signal_automation/executor.py` (current sizing logic)
- `strat/signal_automation/config.py` (execution config)
- `strat/signal_automation/position_monitor.py` (tracks open positions)

### Priority 2: Trade Prioritization Review
- Current prioritization is not working effectively per user feedback
- Review TFC-based priority ranking, timeframe priority, signal scoring
- May need fundamental rethink of which trades get taken

### Priority 3: Railway Dashboard Reconnection
- Railway lost GitHub repo connection (accidental removal)
- Need to reconnect Railway to sheehyct/ATLAS-Trading-System repo
- Dashboard env vars already updated with new Alpaca keys

### Priority 4: Remaining Bugs (Deferred)
- Dashboard patterns show "Unclassified" (data transfer issue)
- TFC not reaching dashboard (0/75 trades show TFC>=4)
- Dashboard minor display issues

---

## Known Bugs (from EQUITY-105 Audit)

| Bug | Status | Description |
|-----|--------|-------------|
| 3-? Pattern Dedup | FIXED + DEPLOYED | Bidirectional patterns create duplicate trades |
| 1H EOD Exits | FIXED + DEPLOYED | PDT detection added, account reset to $100K eliminates PDT |
| Silent Exits | FIXED + DEPLOYED | sync_positions now fires exit callback, stale exits allowed pre-market |
| Dashboard Patterns | DEFERRED | Closed trades show "Unclassified" pattern |
| TFC Not Reaching Dashboard | DEFERRED | 0/75 trades show TFC>=4, may indicate TFC detection bug |
| Dashboard Minor Issues | DEFERRED | Various smaller display/data issues |

---

## Reference Documents

- HANDOFF: `docs/HANDOFF.md`
- CLAUDE.md: `docs/CLAUDE.md` (STRICT COMPLIANCE)
- Problems Audit Plan: `C:\Users\Chris\.claude\plans\snoopy-moseying-crystal.md`
